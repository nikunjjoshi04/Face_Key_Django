{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <script
            crossorigin="anonymous"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            src="https://code.jquery.com/jquery-3.4.1.min.js">
    </script>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script async onload="onOpenCvReady();" src="{% static 'js/opencv.js' %}" type="text/javascript"></script>
    <script src="https://webrtc.github.io/adapter/adapter-5.0.4.js" type="text/javascript"></script>
</head>

<body>

<h2>Hello OpenCV.js</h2>
<p id="status">OpenCV.js is loading...</p>

<div>
    <div class="inputoutput">
        <button id="start" onclick="start();">Start</button>
    </div>
    <div class="inputoutput">
        <video height="400" id="videoInput" width="400"></video>
        <!--        <canvas id="canvasFrame"></canvas>-->
        <canvas id="canvasOutput"></canvas>
        <div class="caption" height="200" width="200">canvasOutput</div>
    </div>
</div>

<script type="text/javascript">
let video = document.getElementById("videoInput");
let stream = null;

function onOpenCvReady() {
  document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
}

function stop(){
        if (video) {
            video.pause();
            video.srcObject = null;
        }
        if (stream) {
            stream.getVideoTracks()[0].stop();
        }
        location.reload();
    };

function start(){
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function(stream) {
            video.srcObject = stream;
            video.play();
        })
        .catch(function(err) {
            console.log("An error occurred! " + err);
        });

    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
    let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
    let cap = new cv.VideoCapture(video);
    let faces = new cv.RectVector();
    let faceCascade = new cv.CascadeClassifier();
    faceCascade.load('/static/xmls/haarcascade_frontalface_default.xml');

    const FPS = 30;

    document.getElementById('start').setAttribute('onclick', 'stop();');
    document.getElementById('start').innerHTML = 'Stop';

    function processVideo() {
        let begin = Date.now();
        cap.read(src);
        cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
        cv.imshow("canvasOutput", dst);
        // schedule next one.
        let delay = 1000/FPS - (Date.now() - begin);
        setTimeout(processVideo, delay);
    }
    // schedule first one.
    setTimeout(processVideo, 0);
}
$(document).ready(function(){
        console.info("JQUERY READY");
       /* $.ajax({
            url:'{% url 'detection:video_ajax' %}',
            data:{
                src:'SRC'
            },
            success:function(response){
                console.info(response.data);
            }
        });*/
    });
</script>
<script>

</script>
</body>
</html>